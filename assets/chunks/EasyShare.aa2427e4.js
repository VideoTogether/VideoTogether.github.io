import{w as D}from"../app.c25e0c02.js";const B={__name:"EasyShare",async setup(P){let i,w;window.VideoTogetherEasyShareMemberSite=!0;const s=window.location.hash.substring(1),b={},c={};c[s]=s,window.m3u8BlobUrlTom3u8Url=c,window.m3u8ContentCache=b;let F=([i,w]=D(async()=>([i,w]=D(()=>fetch("/superplayer.html?x="+Date.now())),i=await i,w(),i).text()),i=await i,w(),i),f=document.createElement("iframe");f.style.display="none",f.src="data:text/html;base64,"+btoa(F),document.body.appendChild(f),setInterval(()=>{videoTogetherExtension.url=window.location.href;try{window.navigator.userAgent.toLowerCase().indexOf("micromessenger")!=-1&&(document.querySelector("#WechatAlert").style.display="block")}catch{}},1e3),window.addEventListener("popstate",e=>{videoTogetherExtension.url=window.location.href});let u=document.createElement("script");u.src="https://cdn.jsdelivr.net/npm/hls.js@1.2.1",document.head.appendChild(u),u=document.createElement("script"),u.src="https://cdn.bootcdn.net/ajax/libs/hls.js/1.2.1/hls.js",document.head.appendChild(u);let C=document.createElement("script");C.src="/release/extension.website.user.js",document.head.appendChild(C),window.m3u8Played=!1,window.m3u8LoadSucc=!1;const _={},L={};window.addEventListener("message",e=>{e.data.method=="fetchResponse"&&(e.data.error==null?_[e.data.url].forEach(o=>{try{o(e.data.blob)}catch{}}):L[e.data.url].forEach(o=>{try{o()}catch{}}))});let S=0,v={};async function j(e){return new Promise(async(o,a)=>{async function r(){try{let d=Date.now()/1e3,E=await videoTogetherExtension.FetchRemoteRealUrl(c[e.frag.baseurl],e.frag.sn,e.url),t=Date.now()/1e3;console.log("FetchRemoteRealUrl time",t-d),o(await A(E))}catch(d){console.error("super fetch failed",d),a()}}try{try{let d=await(await fetch(e.url)).blob();o(d),S++}catch{console.log("normal fetch failed"),S>5&&await r()}}catch{}S>5||await r()})}function R(e,o,a){return e[o]==null&&(e[o]=a),e[o]}async function A(e){return new Promise(async(o,a)=>{try{R(_,e,[]).push(r=>{o(r)}),R(L,e,[]).push(()=>{a()}),f.contentWindow.postMessage({method:"fetch",url:e},"*")}catch{a()}})}setInterval(()=>{function e(r){return r==null?"":r}document.querySelector("#originalVideoUrl").innerText=e(window.VideoTogetherEasyShareTitle),document.querySelector("#originalVideoUrl").href=e(window.VideoTogetherEasyShareUrl),document.querySelector(".easyShareVideo")==null&&(window.VideoTogetherEasyShareMemberSite=!1),s!=window.location.hash.substring(1)&&window.location.reload();let o=document.querySelector("#hlsVideo"),a=document.querySelector("#nativeVideo");try{if(o.readyState>=3){window.m3u8LoadSucc=!0,o.style.display="block",o.VideoTogetherDisabled=!1,Array.from(videoTogetherExtension.videoMap.keys()).forEach(r=>{r!=o.VideoTogetherVideoId&&videoTogetherExtension.videoMap.delete(r)}),a.remove(),T("");return}}catch{}try{if(a.readyState>=3){window.m3u8LoadSucc=!0,Array.from(videoTogetherExtension.videoMap.keys()).forEach(r=>{r!=a.VideoTogetherVideoId&&videoTogetherExtension.videoMap.delete(r)}),a.style.display="block",a.VideoTogetherDisabled=!1,T("");return}}catch{}window.Hls!=null&&(window.m3u8Played||(window.m3u8Played=!0,H(s),setTimeout(()=>{window.m3u8LoadSucc||T(document.querySelector("#LoadTimeoutText").innerText),s!=""&&videoTogetherExtension.roomName!=""&&videoTogetherExtension.roomName!="test"&&document.querySelector("#originalVideoUrl").href!=window.location.href&&(window.m3u8LoadSucc?fetch(window.videoTogetherExtension.video_together_host+"/beta/counter?key=easyshare_succ"):fetch(window.videoTogetherExtension.video_together_host+"/beta/counter?key=easyshare_err&failedUrl="+encodeURIComponent(document.querySelector("#originalVideoUrl").href+"#"+navigator.userAgent)))},2e4)))},500);function T(e){document.querySelector("#StatusText").innerText=e}function H(e){let o=document.querySelector("#hlsVideo"),a=document.querySelector("#nativeVideo");o.VideoTogetherDisabled=!0,a.VideoTogetherDisabled=!0;try{if(Hls.isSupported()){var r=new Hls({pLoader:class extends Hls.DefaultConfig.loader{load(t,h,m){console.log(t);function U(n,l){const M=n.getReader();let x=0;return new ReadableStream({async pull(p){const{value:q,done:I}=await M.read();if(I||x>=l){p.close();return}x+=q.byteLength,p.enqueue(q)},cancel(p){M.cancel(p)}})}function y(n){return n.trim().startsWith("#EXTM3U")}let g=async()=>{for(;;){console.log("FetchRemoteM3u8Content");try{let n=await videoTogetherExtension.FetchRemoteM3u8Content(t.url);b[t.url]=n;let l=URL.createObjectURL(new Blob([b[t.url]],{type:"text/plain"}));c[l]=t.url,t.url=l,super.load(t,h,m);break}catch{await new Promise(l=>setTimeout(l,500))}}};const V=new AbortController;fetch(t.url,{signal:V.signal}).then(n=>{const l=U(n.body,1024);return new Response(l,{headers:n.headers})}).then(n=>n.text()).then(async n=>{V.abort(),y(n)?(console.log("normal fetch m3u8"),super.load(t,h,m)):g()}).catch(n=>{g()})}},fLoader:class extends Hls.DefaultConfig.loader{async load(t,h,m){console.log(t),t.url.startsWith("blob")&&(t.url=new URL(t.frag.relurl,c[t.frag.baseurl]));let U=Date.now()/1e3;if(v[t.url]){console.log("duplicate, abort"),super.load(t,h,m);return}let y=t.url;v[y]=!0;try{t.url=URL.createObjectURL(await j(t))}catch{console.log("abort")}let g=Date.now()/1e3;console.log("fetch time",g-U),v[y]=!1,super.load(t,h,m)}},autoStartLoad:!0,fragLoadingMaxRetry:1e3,manifestLoadingMaxRetry:1e3,levelLoadingMaxRetry:1e3});window.hls=r;var d=e;r.loadSource(d),r.attachMedia(o),o.load()}}catch{}try{a.src=e,a.load()}catch{}}return()=>{}}};export{B as _};
